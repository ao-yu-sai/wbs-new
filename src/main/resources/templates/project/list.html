<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>案件一覧</title>
    <style>
        .project-row {
            cursor: pointer;
        }
        /* テーブルのコンパクト表示用スタイル */
        .table-compact td, 
        .table-compact th {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.2;
        }
        /* ボタンのサイズ調整 */
        .table-compact .btn-sm {
            padding: 0.1rem 0.4rem;
            font-size: 0.75rem;
        }
        .table-container {
            height: 70vh;
            overflow-y: auto;
        }
        /* 説明文の省略表示用スタイル */
        .description-cell {
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .description-cell:hover {
            color: #007bff;
            text-decoration: underline;
        }
        /* 案件名のスタイル */
        .project-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        /* 登録済み機能のスタイル */
        tr.registered-function {
            background-color: #f8f9fa;
        }
        tr.registered-function td {
            color: #6c757d;
        }
        .custom-control-input:disabled ~ .custom-control-label::before {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .custom-checkbox .custom-control-input:checked:disabled ~ .custom-control-label::before {
            background-color: rgba(0, 123, 255, 0.5);
        }
        /* 選択中の行のスタイル */
        .project-row.selected,
        #functionTableBody tr.selected,
        #taskTableBody tr.selected {
            background-color: #e3f2fd !important;
        }
        /* 変更された行のスタイル */
        .modified-row {
            background-color: #ffebee !important;  /* 薄いピンク */
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>案件一覧</h1>
                    </div>
                </div>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <!-- 案件一覧 -->
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">案件一覧</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#projectModal">
                                        <i class="fas fa-plus"></i> 案件登録
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-container" style="height: 70vh;">
                                    <table class="table table-hover text-nowrap table-compact" id="projectTable">
                                        <thead>
                                            <tr>
                                                <th>サービス</th>
                                                <th>チケット</th>
                                                <th>案件名</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="project : ${projects}" 
                                                th:class="${project.isActive} ? 'project-row' : 'project-row text-muted'"
                                                th:data-project-id="${project.ticketNumber}"
                                                th:data-service-kbn-code="${project.serviceKbnCode}"
                                                style="cursor: pointer;">
                                                <td th:text="${project.category?.categoryName}"></td>
                                                <td th:text="${project.ticketNumber}"></td>
                                                <td>
                                                    <div class="project-name" th:text="${project.projectName}"></div>
                                                    <div class="description-cell small text-muted mt-1" 
                                                    th:text="${project.description}"
                                                    th:data-description="${project.description}"
                                                        onclick="showDescription(this)"></div>
                                                </td>
                                                <td>
                                                    <button type="button" 
                                                            class="btn btn-info btn-sm edit-btn"
                                                            th:data-project-id="${project.ticketNumber}">
                                                        <i class="fas fa-edit"></i> 編集
                                                    </button>
                                                    <button type="button" class="btn btn-danger btn-sm delete-btn"
                                                            th:data-project-id="${project.ticketNumber}">
                                                        <i class="fas fa-trash"></i> 削除
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 対象機能一覧 -->
                    <div class="col-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">対象機能一覧</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-primary btn-sm" id="addFunctionBtn" disabled>
                                        <i class="fas fa-plus"></i> 機能追加
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="functionList" style="display: none; height: 70vh; overflow-y: auto;">
                                    <table class="table table-hover text-nowrap table-compact" id="functionTable">
                                        <thead>
                                            <tr>
                                                <th style="display:none;">機能コード</th>
                                                <th>機能名</th>
                                                <th style="width: 80px;">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="functionTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="noProjectSelected" class="text-center p-3">
                                    <p class="text-muted">案件を選択してください</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- タスク一覧 -->
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">タスク一覧</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-primary btn-sm" id="addTaskBtn" disabled>
                                        <i class="fas fa-plus"></i> タスク追加
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="taskList" style="display: none; height: 70vh; overflow-y: auto;">
                                    <table class="table table-hover text-nowrap table-compact" id="taskTable">
                                        <thead>
                                            <tr>
                                                <th>タスク</th>
                                                <th style="width: 300px;">担当者</th>
                                                <th style="width: 100px;">開始予定日</th>
                                                <th style="width: 100px;">終了予定日</th>
                                                <th>予定工数</th>
                                                <th style="width: 100px;">実績開始日</th>
                                                <th style="width: 100px;">実績終了日</th>
                                                <th>実績工数</th>
                                                <th>進捗率</th>
                                            </tr>
                                        </thead>
                                        <tbody id="taskTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="noFunctionSelected" class="text-center p-3">
                                    <p class="text-muted">機能を選択してください</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- プロジェクト登録・編集モーダル -->
        <div class="modal fade" id="projectModal" tabindex="-1" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="projectForm" method="post">
                        <div class="modal-header">
                            <h5 class="modal-title">案件登録</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="ticketNumber">チケット番号</label>
                                <input type="text" class="form-control" id="ticketNumber" name="ticketNumber">
                            </div>
                            <div class="form-group">
                                <label for="categoryId">サービス</label>
                                <select class="form-control" id="categoryId" name="serviceKbnCode" required>
                                    <option value="">選択してください</option>
                                    <th:block th:each="category : ${categories}">
                                        <option th:value="${category.categoryCode}" 
                                                th:text="${category.categoryName}"></option>
                                    </th:block>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="projectName">案件名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="projectName" name="projectName" required>
                            </div>
                            <div class="form-group">
                                <label for="description">説明</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="isActive" name="isActive" checked>
                                    <label class="custom-control-label" for="isActive">有効</label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 説明詳細モーダル -->
        <div class="modal fade" id="descriptionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">説明詳細</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p id="fullDescription" style="white-space: pre-wrap;"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 削除確認モーダル -->
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">削除確認</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>この案件を削除してよろしいですか？</p>
                        <p class="text-danger">この操作は取り消せません。</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                            <i class="fas fa-trash"></i> 削除
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 機能削除確認モーダル -->
        <div class="modal fade" id="deleteFunctionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title">機能削除確認</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                        <p>この機能を削除してよろしいですか？</p>
                        <p class="text-danger">この操作は取り消せません。</p>
                            </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteFunctionBtn">
                            <i class="fas fa-trash"></i> 削除
                        </button>
                            </div>
                            </div>
                                </div>
                            </div>

        <!-- 機能選択モーダル -->
        <div class="modal fade" id="functionSelectModal" tabindex="-1" data-backdrop="static">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">機能選択</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- 検索フィルター -->
                        <div class="form-group">
                            <input type="text" class="form-control" id="functionSearchInput" placeholder="機能名で検索...">
                        </div>
                        <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                            <table class="table table-hover text-nowrap table-compact">
                                <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
                                    <tr>
                                        <th style="width: 40px;">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="selectAllFunctions">
                                                <label class="custom-control-label" for="selectAllFunctions"></label>
                                            </div>
                                        </th>
                                        <th style="width: 10px;">機能コード</th>
                                        <th>機能名</th>
                                    </tr>
                                </thead>
                                <tbody id="availableFunctionTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-primary" id="addSelectedFunctionsBtn">追加</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- タスク追加モーダル -->
        <div class="modal fade" id="taskModal" tabindex="-1" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="taskForm" method="post">
                        <div class="modal-header">
                            <h5 class="modal-title">タスク追加</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                                <table class="table table-hover text-nowrap table-compact">
                                    <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
                                        <tr>
                                            <th style="width: 40px;">
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="selectAllTasks">
                                                    <label class="custom-control-label" for="selectAllTasks"></label>
                                                </div>
                                            </th>
                                            <th>区分コード</th>
                                            <th>区分名</th>
                                        </tr>
                                    </thead>
                                    <tbody id="taskCategoryTableBody">
                                        <tr th:each="category : ${taskCategories}">
                                            <td>
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input task-checkbox"
                                                           th:id="'task_' + ${category.categoryCode}"
                                                           th:value="${category.categoryCode}">
                                                    <label class="custom-control-label" 
                                                           th:for="'task_' + ${category.categoryCode}"></label>
                                                </div>
                                            </td>
                                            <td th:text="${category.categoryCode}"></td>
                                            <td th:text="${category.categoryName}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                            <button type="submit" class="btn btn-primary">追加</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script>
            // 削除対象の案件ID
            let deleteTargetId = null;
            // 選択中の案件ID
            let selectedProjectId = null;
            // 削除対象の機能情報
            let deleteFunctionInfo = null;

            /**
             * 説明文クリック時の処理
             * 説明文の全文をモーダルで表示する
             */
            function showDescription(element) {
                const description = element.getAttribute('data-description');
                document.getElementById('fullDescription').textContent = description || '説明なし';
                $('#descriptionModal').modal('show');
            }

            $(document).ready(function() {
                // toastrの設定
                toastr.options = {
                    positionClass: 'toast-bottom-right',  // 右下に表示
                    timeOut: 3000,  // 3秒後に消える
                    closeButton: true,  // 閉じるボタンを表示
                    progressBar: true  // プログレスバーを表示
                };

                /**
                 * 案件行のクリックイベント
                 * 案件を選択し、対応する機能一覧を表示する
                 */
                $(document).on('click', '.project-row', function(e) {
                    // 編集・削除ボタンと説明文のクリックイベントが伝播しないようにする
                    if ($(e.target).closest('.btn').length > 0 || $(e.target).closest('.description-cell').length > 0) {
                        return;
                    }
                    
                    const projectId = $(this).data('project-id');
                    const serviceKbnCode=$(this).data('service-kbn-code');
                    
                    // 選択状態の更新（背景色の変更）
                    $('.project-row').removeClass('selected');
                    $(this).addClass('selected');
                    
                    if (selectedProjectId !== projectId) {
                        selectedProjectId = projectId;
                        // 機能一覧を読み込み
                        loadProjectFunctions(serviceKbnCode,projectId);
                        // 機能追加ボタンを有効化
                        $('#addFunctionBtn').prop('disabled', false);

                        // タスク一覧をクリアして非表示にする
                        $('#taskTableBody').empty();
                        $('#taskList').hide();
                        $('#noFunctionSelected').show();
                        $('#addTaskBtn').prop('disabled', true);
                    }
                });

                /**
                 * 機能追加ボタンのクリックイベント
                 * 選択中の案件のサービス区分に紐づく機能一覧を表示する
                 */
                $('#addFunctionBtn').click(function() {
                    if (!selectedProjectId) return;
                    
                    // 選択中の案件行からサービス区分コードを取得
                    const selectedRow = $(`tr[data-project-id="${selectedProjectId}"]`);
                    const serviceKbnCode = selectedRow.data('service-kbn-code');

                    // 現在登録されている機能コードを取得
                    const registeredFunctionCodes = new Set();
                    $('#functionTableBody tr').each(function() {
                        const functionCode = $(this).find('td:first').text();
                        if (functionCode) {
                            registeredFunctionCodes.add(functionCode);
                        }
                    });

                    // サービス区分に紐づく機能一覧を取得して表示
                    $.get(`/projects/${serviceKbnCode}/available-functions`)
                        .done(function(functions) {
                            const tbody = $('#availableFunctionTableBody');
                            tbody.empty();
                            
                            // 機能一覧をテーブルに表示
                            functions.forEach(function(func) {
                                const isRegistered = registeredFunctionCodes.has(func.functionCode);
                                const row = $('<tr>');
                                if (isRegistered) {
                                    row.addClass('registered-function');
                                }
                                const checkbox = `
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input function-checkbox" 
                                               id="func_${func.functionCode}" 
                                               value="${func.functionCode}"
                                               ${isRegistered ? 'checked disabled' : ''}>
                                        <label class="custom-control-label" for="func_${func.functionCode}"></label>
                                    </div>
                                `;
                                row.append($('<td>').html(checkbox));
                                row.append($('<td>').text(func.functionCode));
                                row.append($('<td>').text(func.functionName));
                                tbody.append(row);
                            });

                            $('#functionSelectModal').modal('show');
                        })
                        .fail(function(xhr) {
                            toastr.error('機能一覧の取得に失敗しました：' + xhr.responseText);
                        });
                });

                /**
                 * 利用可能な機能一覧の取得と表示
                 * @param {string} serviceKbnCode - サービス区分コード
                 */
                function loadAvailableFunctions(serviceKbnCode) {
                    $.get(`/api/functions/service/${serviceKbnCode}`)
                        .done(function(functions) {
                            const tbody = $('#availableFunctionTableBody');
                            tbody.empty();
                            
                            // 機能一覧をテーブルに表示
                            functions.forEach(function(func) {
                                const row = $('<tr>');
                                row.append($('<td style="display:none;">').text(func.functionCode));
                                row.append($('<td>').text(func.functionCode));
                                row.append($('<td>').text(func.function?.functionName || ''));
                                row.append($('<td>').html(`
                                    <button type="button" class="btn btn-danger btn-sm delete-function-btn"
                                            data-function-code="${func.functionCode}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `));
                                tbody.append(row);
                            });
                        })
                        .fail(function(xhr) {
                            toastr.error('機能一覧の取得に失敗しました：' + xhr.responseText);
                        });
                }

                /**
                 * 全選択チェックボックスの処理
                 * 全ての機能を選択/解除する
                 */
                $('#selectAllFunctions').change(function() {
                    const isChecked = $(this).prop('checked');
                    // 無効化されていないチェックボックスのみを対象にする
                    $('.function-checkbox:not(:disabled)').prop('checked', isChecked);
                    // 追加ボタンの有効/無効を更新
                    updateAddButtonState();
                });

                /**
                 * チェックボックスの状態変更時の処理
                 * 選択された機能の数に応じて追加ボタンの有効/無効を切り替える
                 */
                $(document).on('change', '.function-checkbox', function() {
                    updateAddButtonState();
                    // 全選択チェックボックスの状態を更新
                    updateSelectAllCheckboxState();
                });

                /**
                 * 追加ボタンの状態を更新する
                 */
                function updateAddButtonState() {
                    const checkedCount = $('.function-checkbox:checked:not(:disabled)').length;
                    $('#addSelectedFunctionsBtn').prop('disabled', checkedCount === 0);
                }

                /**
                 * 全選択チェックボックスの状態を更新する
                 */
                function updateSelectAllCheckboxState() {
                    const totalCheckboxes = $('.function-checkbox:not(:disabled)').length;
                    const checkedCheckboxes = $('.function-checkbox:checked:not(:disabled)').length;
                    
                    $('#selectAllFunctions').prop({
                        checked: totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes,
                        indeterminate: checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes
                    });
                }

                /**
                 * 選択された機能の追加処理
                 * チェックされた機能を案件に紐付ける
                 */
                $('#addSelectedFunctionsBtn').click(function() {
                    const selectedFunctions = [];
                    $('.function-checkbox:checked:not(:disabled)').each(function() {
                        selectedFunctions.push($(this).val());
                    });

                    if (selectedFunctions.length === 0) {
                        toastr.warning('追加可能な機能が選択されていません');
                        return;
                    }

                    // 選択中の案件のサービス区分コードを取得
                    const selectedRow = $(`tr[data-project-id="${selectedProjectId}"]`);
                    const serviceKbnCode = selectedRow.data('service-kbn-code');

                    // 選択された機能を案件に紐付ける
                    $.ajax({
                        url: `/projects/${selectedProjectId}/project-functions`,
                        method: 'POST',
                        traditional: true,
                        data: {
                            serviceKbnCode: serviceKbnCode,
                            functionCodes: selectedFunctions
                        },
                        success: function() {
                            $('#functionSelectModal').modal('hide');
                            toastr.success('機能を追加しました');
                            // 機能一覧を再読み込み
                            loadProjectFunctions(serviceKbnCode, selectedProjectId);
                        },
                        error: function(xhr) {
                            toastr.error('機能の追加に失敗しました：' + xhr.responseText);
                        }
                    });
                });

                /**
                 * 機能選択モーダルが開かれたときの処理
                 */
                $('#functionSelectModal').on('shown.bs.modal', function() {
                    $('#functionSearchInput').val('').focus();
                    // 追加ボタンを無効化
                    $('#addSelectedFunctionsBtn').prop('disabled', true);
                });

                /**
                 * 機能選択モーダルが閉じられたときの処理
                 */
                $('#functionSelectModal').on('hidden.bs.modal', function() {
                    $('#selectAllFunctions').prop('checked', false);
                    $('#availableFunctionTableBody').empty();
                    // 追加ボタンを無効化
                    $('#addSelectedFunctionsBtn').prop('disabled', true);
                });

                /**
                 * 機能一覧の取得と表示
                 * @param {string} serviceKbnCode - サービス区分コード
                 * @param {string} projectId - 案件ID（チケット番号）
                 */
                function loadProjectFunctions(serviceKbnCode, projectId) {
                    $('#noProjectSelected').hide();
                    $('#functionList').show();
                    
                    $.get(`/projects/${projectId}/project-functions`, {
                        serviceKbnCode: serviceKbnCode
                    })
                    .done(function(functions) {
                        const tbody = $('#functionTableBody');
                        tbody.empty();
                        
                        if (functions.length === 0) {
                            tbody.append($('<tr>').append(
                                $('<td colspan="3" class="text-center text-muted">').text('対象機能が登録されていません')
                            ));
                            return;
                        }

                        functions.forEach(function(func) {
                            const row = $('<tr>');
                            row.append($('<td style="display:none;">').text(func.functionCode));
                            row.append($('<td>').text(func.function?.functionName || ''));
                            row.append($('<td>').html(`
                                <button type="button" class="btn btn-danger btn-sm delete-function-btn"
                                        data-function-code="${func.functionCode}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `));
                            tbody.append(row);
                        });
                    })
                    .fail(function(xhr) {
                        toastr.error('機能一覧の取得に失敗しました：' + xhr.responseText);
                    });
                }

                // 機能行のクリックイベント
                $(document).on('click', '#functionTableBody tr', function(e) {
                    // 削除ボタンのクリックイベントが伝播しないようにする
                    if ($(e.target).closest('.btn').length > 0) {
                        return;
                    }

                    // 選択状態の更新（背景色の変更）
                    $('#functionTableBody tr').removeClass('selected');
                    $(this).addClass('selected');

                    // 機能コードを取得
                    const functionCode = $(this).find('td:first').text();

                    // タスク一覧を取得
                    loadTaskList(selectedProjectId, functionCode);
                    
                    // タスク追加ボタンを有効化
                    $('#addTaskBtn').prop('disabled', false);
                });

                /**
                 * タスク一覧の取得と表示
                 */
                function loadTaskList(ticketNumber, functionCode) {
                    $('#noFunctionSelected').hide();
                    $('#taskList').show();

                    // 選択中の案件のサービス区分コードを取得
                    const selectedRow = $(`tr[data-project-id="${ticketNumber}"]`);
                    const serviceKbnCode = selectedRow.data('service-kbn-code');

                    $.get(`/projects/${ticketNumber}/functions/${functionCode}/tasks`, {
                        serviceKbnCode: serviceKbnCode
                    })
                    .done(function(tasks) {
                        const tbody = $('#taskTableBody');
                        tbody.empty();

                        if (tasks.length === 0) {
                            tbody.append($('<tr>').append(
                                $('<td colspan="9" class="text-center text-muted">').text('タスクが登録されていません')
                            ));
                            return;
                        }

                        tasks.forEach(function(task) {
                            appendTaskToTable(task);
                        });
                    })
                    .fail(function(xhr) {
                        toastr.error('タスク一覧の取得に失敗しました：' + xhr.responseText);
                    });
                }

                function appendTaskToTable(task) {
                    const row = $('<tr>');
                    row.append($('<td>').text(task.taskName));
                    
                    // 担当者（コンボボックスで選択）
                    const personInChargeSelect = $('<select style="width:100px;">')
                        .addClass('form-control form-control-sm')
                        .on('change', function() {
                            updateTask(task, { personInCharge: $(this).val() });
                        });
                    
                    // 担当者一覧を取得してコンボボックスに追加
                    $.get('/api/staff/list')
                        .done(function(staffList) {
                            // 空の選択肢を追加
                            personInChargeSelect.append($('<option>').val('').text(''));
                            
                            // 担当者一覧を追加
                            staffList.forEach(function(staff) {
                                const option = $('<option>')
                                    .val(staff.email)
                                    .text(staff.staffName)
                                    .prop('selected', staff.email === task.personInCharge);
                                personInChargeSelect.append(option);
                            });
                        })
                        .fail(function() {
                            toastr.error('担当者一覧の取得に失敗しました。');
                        });
                    
                    row.append($('<td>').append(personInChargeSelect));

                    // 予定開始日（入力可能）
                    const plannedStartDateInput = $('<input>')
                        .attr('type', 'date')
                        .addClass('form-control form-control-sm')
                        .val(formatDateForInput(task.plannedStartDate))
                        .on('change', function() {
                            updateTask(task, { plannedStartDate: $(this).val() });
                        });
                    row.append($('<td>').append(plannedStartDateInput));

                    // 予定終了日（入力可能）
                    const plannedEndDateInput = $('<input>')
                        .attr('type', 'date')
                        .addClass('form-control form-control-sm')
                        .val(formatDateForInput(task.plannedEndDate))
                        .on('change', function() {
                            updateTask(task, { plannedEndDate: $(this).val() });
                        });
                    row.append($('<td>').append(plannedEndDateInput));

                    // 予定工数（入力可能）
                    const plannedManHoursInput = $('<input>')
                        .attr('type', 'number')
                        .attr('step', '0.5')
                        .addClass('form-control form-control-sm')
                        .val(task.plannedManHours || '')
                        .on('change', function() {
                            updateTask(task, { plannedManHours: $(this).val() });
                        });
                    row.append($('<td>').append(plannedManHoursInput));

                    // 実績開始日（入力可能）
                    const actualStartDateInput = $('<input>')
                        .attr('type', 'date')
                        .addClass('form-control form-control-sm')
                        .val(formatDateForInput(task.actualStartDate))
                        .on('change', function() {
                            updateTask(task, { actualStartDate: $(this).val() });
                        });
                    row.append($('<td>').append(actualStartDateInput));

                    // 実績終了日（入力可能）
                    const actualEndDateInput = $('<input>')
                        .attr('type', 'date')
                        .addClass('form-control form-control-sm')
                        .val(formatDateForInput(task.actualEndDate))
                        .on('change', function() {
                            updateTask(task, { actualEndDate: $(this).val() });
                        });
                    row.append($('<td>').append(actualEndDateInput));

                    // 実績工数（入力可能）
                    const actualManHoursInput = $('<input>')
                        .attr('type', 'number')
                        .attr('step', '0.5')
                        .addClass('form-control form-control-sm')
                        .val(task.actualManHours || '')
                        .on('change', function() {
                            updateTask(task, { actualManHours: $(this).val() });
                        });
                    row.append($('<td>').append(actualManHoursInput));

                    // 進捗率（入力可能）
                    const progressRateInput = $('<input>')
                        .attr('type', 'number')
                        .attr('min', '0')
                        .attr('max', '100')
                        .addClass('form-control form-control-sm')
                        .val(task.progressRate || '')
                        .on('change', function() {
                            updateTask(task, { progressRate: $(this).val() });
                        });
                    row.append($('<td>').append(progressRateInput));

                    $('#taskTableBody').append(row);
                }

                function updateTask(task, updates) {
                    // 現在の入力値を全て取得
                    const row = $(event.target).closest('tr');
                    const currentValues = {
                        ticketNumber: task.ticketNumber,
                        serviceKbnCode: task.serviceKbnCode,
                        functionCode: task.functionCode,
                        taskKbnCode: task.taskKbnCode,
                        taskName: task.taskName,
                        personInCharge: row.find('select').val(),
                        plannedStartDate: row.find('input[type="date"]').eq(0).val(),
                        plannedEndDate: row.find('input[type="date"]').eq(1).val(),
                        plannedManHours: row.find('input[type="number"]').eq(0).val(),
                        actualStartDate: row.find('input[type="date"]').eq(2).val(),
                        actualEndDate: row.find('input[type="date"]').eq(3).val(),
                        actualManHours: row.find('input[type="number"]').eq(1).val(),
                        progressRate: row.find('input[type="number"]').eq(2).val()
                    };

                    // 更新内容をマージ
                    const updatedTask = { ...currentValues, ...updates };

                    $.ajax({
                        url: '/projects/tasks/update',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(updatedTask),
                        success: function() {
                            toastr.success('タスク情報を更新しました。');
                            // 変更された行の背景色を変更
                            row.addClass('modified-row');
                        },
                        error: function() {
                            toastr.error('タスク情報の更新に失敗しました。');
                        }
                    });
                }

                // タスク追加ボタンのクリックイベント
                $('#addTaskBtn').click(function() {
                    if (!selectedProjectId) return;

                    // 選択中の機能行から機能コードを取得
                    const selectedFunctionRow = $('#functionTableBody tr.selected');
                    if (selectedFunctionRow.length === 0) {
                        toastr.warning('機能を選択してください');
                        return;
                    }

                    const functionCode = selectedFunctionRow.find('td:first').text();
                    
                    // 選択中の案件のサービス区分コードを取得
                    const selectedRow = $(`tr[data-project-id="${selectedProjectId}"]`);
                    const serviceKbnCode = selectedRow.data('service-kbn-code');

                    // タスク追加モーダルを表示
                    $('#taskModal').modal('show');
                });

                // タスクフォームの送信処理
                $('#taskForm').submit(function(e) {
                    e.preventDefault();

                    // 選択中の機能行から機能コードを取得
                    const selectedFunctionRow = $('#functionTableBody tr.selected');
                    const functionCode = selectedFunctionRow.find('td:first').text();
                    
                    // 選択中の案件のサービス区分コードを取得
                    const selectedRow = $(`tr[data-project-id="${selectedProjectId}"]`);
                    const serviceKbnCode = selectedRow.data('service-kbn-code');

                    // 選択されたタスク区分を取得
                    const selectedTaskCodes = [];
                    $('.task-checkbox:checked').each(function() {
                        selectedTaskCodes.push($(this).val());
                    });

                    if (selectedTaskCodes.length === 0) {
                        toastr.warning('タスク区分を選択してください');
                        return;
                    }

                    // タスクを登録（1タスク1レコード）
                    const promises = selectedTaskCodes.map(taskKbnCode => {
                        return $.ajax({
                            url: `/projects/project-function-tasks`,
                            method: 'POST',
                            traditional: true,
                            data: {
                                ticketNumber: selectedProjectId,
                                serviceKbnCode: serviceKbnCode,
                                functionCode: functionCode,
                                taskKbnCode: taskKbnCode
                            }
                        });
                    });

                    // すべてのタスク登録が完了したら
                    Promise.all(promises)
                        .then(() => {
                            $('#taskModal').modal('hide');
                            toastr.success('タスクを登録しました');
                            // タスク一覧を再読み込み
                            loadTaskList(selectedProjectId, functionCode);
                            // フォームをリセット
                            $('#taskForm').trigger('reset');
                        })
                        .catch(error => {
                            toastr.error('タスクの登録に失敗しました：' + error.responseText);
                        });
                });

                // 全選択チェックボックスの処理
                $('#selectAllTasks').change(function() {
                    const isChecked = $(this).prop('checked');
                    $('.task-checkbox').prop('checked', isChecked);
                });

                // 個別のチェックボックス変更時の処理
                $(document).on('change', '.task-checkbox', function() {
                    const totalCheckboxes = $('.task-checkbox').length;
                    const checkedCheckboxes = $('.task-checkbox:checked').length;
                    
                    $('#selectAllTasks').prop({
                        checked: totalCheckboxes === checkedCheckboxes,
                        indeterminate: checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes
                    });
                });

                // タスクモーダルが閉じられたときの処理
                $('#taskModal').on('hidden.bs.modal', function() {
                    $('#taskForm').trigger('reset');
                    $('#selectAllTasks').prop('checked', false);
                });

                // 日付入力のフォーマットを設定
                $(document).on('focus', 'input[type="date"]', function() {
                    // カレンダーを表示させるため、typeの変更は行わない
                    $(this).attr('placeholder', 'YYYY/MM/DD');
                });

                // 日付フォーマット用の関数
                function formatDateForInput(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`; // カレンダー用にハイフン区切りに変更
                }
            });
        </script>
    </th:block>
</body>
</html>